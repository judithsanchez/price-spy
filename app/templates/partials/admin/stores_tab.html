<div x-data="storesManager()" x-init="loadStores()">
    <div class="flex justify-end mb-4">
        <button @click="resetForm()"
                class="bg-jolly text-jolly-dark px-6 py-2.5 rounded-2xl hover:bg-jolly-lime transition-all font-black uppercase tracking-widest text-[10px] shadow-sm border border-jolly-dark/5">
            Add New Store
        </button>
    </div>

    <!-- Desktop Table View -->
    <div class="bg-white rounded-3xl shadow-sm overflow-hidden border border-jolly-dark/5">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-jolly-dark/5">
                <thead class="bg-gray-50/50 text-[10px] font-black text-jolly-dark/40 uppercase tracking-widest">
                    <tr>
                        <th class="px-6 py-4 text-left">Name</th>
                        <th class="px-6 py-4 text-left">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-jolly-dark/5">
                    <template x-for="store in stores" :key="store.id">
                        <tr class="hover:bg-jolly/5 transition-colors group">
                            <td class="px-6 py-5 max-w-xs font-black text-jolly-dark" x-text="store.name"></td>
                            <td class="px-6 py-5 whitespace-nowrap">
                                <div class="flex gap-4">
                                    <button @click="editStore(store)" class="text-lg hover:scale-125 transition-transform" title="Edit">‚úèÔ∏è</button>
                                    <button @click="deleteStore(store.id)" class="text-lg hover:scale-125 transition-transform" title="Delete">üóëÔ∏è</button>
                                </div>
                            </td>
                        </tr>
                    </template>
                    <tr x-show="stores.length === 0">
                        <td colspan="2" class="px-6 py-4 text-center text-gray-400 font-medium italic">No stores found</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Form -->
    {% call modal_wrapper('showForm', 'Store', 'showForm = false', 'editingStore') %}
        <form @submit.prevent="saveStore()">
            {{ form_field('Store Name', 'formData.name', required=true) }}

            <div class="flex flex-col-reverse sm:flex-row justify-end gap-3 px-6 py-5 bg-gray-50/30 border-t border-jolly-dark/5 rounded-b-3xl mt-6 -mx-6 -mb-6 sm:-mx-8 sm:-mb-8">
                <button type="button" @click="showForm = false" class="px-6 py-3 bg-white text-jolly-dark/60 font-black rounded-2xl hover:bg-gray-100 transition-all uppercase tracking-widest text-[10px]">Cancel</button>
                <button type="submit" class="px-8 py-3 bg-jolly text-jolly-dark font-black rounded-2xl hover:bg-jolly-lime transition-all uppercase tracking-widest text-[10px]">
                    <span x-text="editingStore ? 'Save Changes' : 'Add Store'"></span>
                </button>
            </div>
        </form>
    {% endcall %}
</div>

<script>
function storesManager() {
    return {
        stores: [],
        showForm: false,
        editingStore: null,
        error: null,
        formData: { name: '' },
        async loadStores() {
            const r = await fetch('/api/stores');
            this.stores = await r.json();
        },
        resetForm() {
            this.editingStore = null;
            this.error = null;
            this.formData = { name: '' };
            this.showForm = true;
        },
        editStore(store) {
            this.editingStore = store;
            this.error = null;
            this.formData = { name: store.name };
            this.showForm = true;
        },
        async saveStore() {
            const method = this.editingStore ? 'PUT' : 'POST';
            const url = this.editingStore ? `/api/stores/${this.editingStore.id}` : '/api/stores';
            const res = await fetch(url, {
                method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(this.formData)
            });
            if (res.ok) { this.showForm = false; this.loadStores(); }
            else { const e = await res.json(); this.error = e.detail; }
        },
        async deleteStore(id) {
            if (confirm('Delete store?')) {
                const res = await fetch(`/api/stores/${id}`, {method: 'DELETE'});
                if (res.ok) {
                    this.loadStores();
                } else {
                    const e = await res.json();
                    alert(e.detail || 'Failed to delete store');
                }
            }
        }
    }
}
</script>
