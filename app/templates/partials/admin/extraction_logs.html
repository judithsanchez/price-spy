<div x-data="fullLogs()" x-init="init()">
    {% include 'partials/log-filters.html' %}
    
    <div x-show="loading" class="text-center py-12 text-jolly-dark/40 italic font-medium">Loading history...</div>
    <div x-show="!loading && logs.length === 0" class="text-center py-12 text-jolly-dark/40 italic font-medium">No extraction events recorded.</div>

    <div x-show="!loading && logs.length > 0" class="overflow-hidden rounded-2xl border border-jolly-dark/5">
        <table class="w-full text-left border-collapse">
            <thead class="bg-gray-50/50 text-[10px] font-black text-jolly-dark/40 uppercase tracking-widest border-b border-jolly-dark/5">
                <tr>
                    <th class="px-6 py-4">Time</th>
                    <th class="px-6 py-4">Item</th>
                    <th class="px-6 py-4 text-center">Status</th>
                    <th class="px-6 py-4">Price</th>
                    <th class="px-6 py-4 hidden lg:table-cell">Details</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-jolly-dark/5">
                <template x-for="log in logs" :key="log.id">
                    <tr class="hover:bg-jolly/5 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap text-[11px] font-bold text-jolly-dark/60" x-text="formatTime(log.created_at)"></td>
                        <td class="px-6 py-4 whitespace-nowrap text-[11px] font-black text-jolly-dark">
                            <a :href="'/tracked-items#' + log.tracked_item_id" class="px-2 py-1 bg-gray-100 rounded-lg hover:bg-jolly hover:text-jolly-dark transition-all" x-text="'#' + log.tracked_item_id"></a>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="px-2 py-1 text-[9px] font-black uppercase tracking-widest rounded-lg" 
                                  :class="{ 'bg-jolly-lime/20 text-jolly-dark border border-jolly-lime/30': log.status === 'success', 'bg-jolly-rose/20 text-jolly-vivid border border-jolly-rose/30': log.status === 'error' }" x-text="log.status"></span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-[12px] font-black text-jolly-dark">
                            <span x-show="log.price" x-text="log.price ? log.currency + ' ' + log.price.toFixed(2) : ''"></span>
                            <span x-show="!log.price" class="text-jolly-dark/20">-</span>
                        </td>
                        <td class="px-6 py-4 text-[11px] font-bold text-jolly-dark/60 hidden lg:table-cell">
                            <div class="max-w-xs truncate" :title="log.error_message" x-text="log.error_message || 'OK'"></div>
                        </td>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <!-- Pagination -->
    <div x-show="!loading && logs.length > 0" class="flex justify-between items-center mt-6 p-4 bg-gray-50/50 rounded-2xl border border-jolly-dark/5">
        <button @click="prevPage()" :disabled="page <= 1" class="px-4 py-2 bg-white rounded-xl font-black text-[10px] uppercase tracking-widest border border-jolly-dark/10 shadow-sm disabled:opacity-30">Prev</button>
        <span class="text-[10px] font-black text-jolly-dark/30 uppercase tracking-widest tracking-tighter">Page <span x-text="page"></span></span>
        <button @click="nextPage()" :disabled="!hasMore" class="px-4 py-2 bg-white rounded-xl font-black text-[10px] uppercase tracking-widest border border-jolly-dark/10 shadow-sm disabled:opacity-30">Next</button>
    </div>
</div>

<script>
if (typeof fullLogs !== 'function') {
    function fullLogs() {
        return {
            logs: [], loading: true, page: 1, limit: 100, hasMore: false,
            filters: { status: '', itemId: '', startDate: '', endDate: '' },
            init() { 
                this.loadLogs(); 
                const handler = e => { this.filters = e.detail; this.page = 1; this.loadLogs(); };
                window.addEventListener('log-filter-changed', handler);
            },
            buildQuery() {
                let q = `?limit=${this.limit}&offset=${(this.page - 1) * this.limit}`;
                if (this.filters.status) q += `&status=${this.filters.status}`;
                if (this.filters.itemId) q += `&item_id=${this.filters.itemId}`;
                if (this.filters.startDate) q += `&start_date=${this.filters.startDate}`;
                if (this.filters.endDate) q += `&end_date=${this.filters.endDate}`;
                return q;
            },
            async loadLogs() {
                this.loading = true;
                try {
                    const res = await fetch(`/api/logs${this.buildQuery()}`);
                    const data = await res.json();
                    this.logs = data;
                    this.hasMore = data.length === this.limit;
                } catch (e) { console.error('Failed to load logs:', e); }
                finally { this.loading = false; }
            },
            nextPage() { if (this.hasMore) { this.page++; this.loadLogs(); } },
            prevPage() { if (this.page > 1) { this.page--; this.loadLogs(); } },
            formatTime(iso) { return iso ? new Date(iso).toLocaleString('en-US', { hour: '2-digit', minute: '2-digit', second: '2-digit', hour12: false }) : '-'; }
        }
    }
}
</script>
