<div x-data="categoriesManager()" x-init="loadCategories()">
    <div class="flex justify-end mb-4">
        <button @click="resetForm()"
                class="bg-jolly text-jolly-dark px-6 py-2.5 rounded-2xl hover:bg-jolly-lime transition-all font-black uppercase tracking-widest text-[10px] shadow-sm border border-jolly-dark/5">
            Add New Category
        </button>
    </div>

    <!-- Desktop Table View -->
    <div class="bg-white rounded-3xl shadow-sm overflow-hidden border border-jolly-dark/5">
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-jolly-dark/5">
                <thead class="bg-gray-50/50 text-[10px] font-black text-jolly-dark/40 uppercase tracking-widest">
                    <tr>
                        <th class="px-6 py-4 text-left">Name</th>
                        <th class="px-6 py-4 text-left">Created At</th>
                        <th class="px-6 py-4 text-left">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-jolly-dark/5">
                    <template x-for="category in categories" :key="category.id">
                        <tr class="hover:bg-jolly/5 transition-colors group">
                            <td class="px-6 py-5 font-black text-jolly-dark" x-text="category.name"></td>
                            <td class="px-6 py-5 whitespace-nowrap text-jolly-dark/40 text-xs font-bold" x-text="formatDate(category.created_at)"></td>
                            <td class="px-6 py-5 whitespace-nowrap">
                                <div class="flex gap-4">
                                    <button @click="editCategory(category)" class="text-lg hover:scale-125 transition-transform" title="Edit">‚úèÔ∏è</button>
                                    <button @click="deleteCategory(category.id)" class="text-lg hover:scale-125 transition-transform" title="Delete">üóëÔ∏è</button>
                                </div>
                            </td>
                        </tr>
                    </template>
                    <tr x-show="categories.length === 0">
                        <td colspan="3" class="px-6 py-4 text-center text-gray-400 font-medium italic">No categories found</td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- Modal Form -->
    {% call modal_wrapper('showForm', 'Category', 'showForm = false', is_editing_var='editingCategory') %}
        <form @submit.prevent="saveCategory()">
            {{ form_field('Category Name', 'formData.name', required=true) }}
            
            <div class="flex flex-col-reverse sm:flex-row justify-end gap-3 px-6 py-5 bg-gray-50/30 border-t border-jolly-dark/5 rounded-b-3xl mt-6 -mx-6 -mb-6 sm:-mx-8 sm:-mb-8">
                <button type="button" @click="showForm = false" class="px-6 py-3 bg-white text-jolly-dark/60 font-black rounded-2xl hover:bg-gray-100 transition-all uppercase tracking-widest text-[10px]">Cancel</button>
                <button type="submit" class="px-8 py-3 bg-jolly text-jolly-dark font-black rounded-2xl hover:bg-jolly-lime transition-all uppercase tracking-widest text-[10px]">
                    <span x-text="editingCategory ? 'Save Changes' : 'Add Category'"></span>
                </button>
            </div>
        </form>
    {% endcall %}
</div>

<script>
function categoriesManager() {
    return {
        categories: [],
        showForm: false,
        editingCategory: null,
        error: null,
        formData: { name: '', is_size_sensitive: false },
        async loadCategories() {
            const r = await fetch('/api/categories');
            this.categories = await r.json();
        },
        resetForm() {
            this.editingCategory = null;
            this.error = null;
            this.formData = { name: '', is_size_sensitive: false };
            this.showForm = true;
        },
        editCategory(cat) {
            this.editingCategory = cat;
            this.error = null;
            this.formData = { ...cat };
            this.showForm = true;
        },
        async saveCategory() {
            const method = this.editingCategory ? 'PUT' : 'POST';
            const url = this.editingCategory ? `/api/categories/${this.editingCategory.id}` : '/api/categories';
            const res = await fetch(url, {
                method,
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(this.formData)
            });
            if (res.ok) { this.showForm = false; this.loadCategories(); }
            else { const e = await res.json(); this.error = e.detail; }
        },
        async deleteCategory(id) {
            if (confirm('Delete category?')) {
                await fetch(`/api/categories/${id}`, {method: 'DELETE'});
                this.loadCategories();
            }
        },
        formatDate(v) { return new Date(v).toLocaleDateString(); }
    }
}
</script>
