{% extends "base.html" %}

{% block title %}System Logs - Price Spy{% endblock %}

{% block content %}
<div class="mb-10">
    <h2 class="text-3xl font-black text-jolly-dark flex items-center gap-3 uppercase tracking-tighter">
        <span>üìú System Logs</span>
    </h2>
    <p class="text-jolly-dark/50 text-[11px] font-bold uppercase tracking-widest mt-1 ml-1">Detailed history of all system events</p>
</div>

<div x-data="{ tab: 'extraction' }" class="bg-white rounded-3xl shadow-xl shadow-jolly-dark/5 overflow-hidden border border-jolly-dark/5">
    <!-- Tabs -->
    <div class="border-b border-jolly-dark/5 bg-gray-50/50 overflow-x-auto">
        <nav class="-mb-px flex px-4 sm:px-6 min-w-max gap-2" aria-label="Tabs">
            <button @click="tab = 'extraction'"
                    :class="{ 'bg-white text-jolly-dark border-x border-t border-jolly-dark/5 rounded-t-2xl shadow-sm': tab === 'extraction', 'text-jolly-dark/40 hover:text-jolly-dark hover:bg-white/50 transition-all': tab !== 'extraction' }"
                    class="whitespace-nowrap py-4 px-6 font-black text-[11px] uppercase tracking-widest mt-2">
                ‚ö° Extraction Logs
            </button>
            <button @click="tab = 'error'"
                    :class="{ 'bg-white text-jolly-dark border-x border-t border-jolly-dark/5 rounded-t-2xl shadow-sm': tab === 'error', 'text-jolly-dark/40 hover:text-jolly-dark hover:bg-white/50 transition-all': tab !== 'error' }"
                    class="whitespace-nowrap py-4 px-6 font-black text-[11px] uppercase tracking-widest mt-2">
                ‚ö†Ô∏è Error Logs
            </button>
        </nav>
    </div>

    <!-- Extraction Logs Panel -->
    <div x-show="tab === 'extraction'" class="p-3 sm:p-4" x-data="fullLogs()">
        {% include 'partials/log-filters.html' %}
        <div x-show="loading" class="text-center p-8 text-gray-500">Loading logs...</div>
        <div x-show="!loading && logs.length === 0" class="text-center p-8 text-gray-500">No logs found.</div>

        <!-- Mobile Card View -->
        <div x-show="!loading && logs.length > 0" class="sm:hidden space-y-3">
            <template x-for="log in logs" :key="log.id">
            <div class="border border-jolly-dark/5 rounded-2xl p-4 shadow-sm" :class="log.status === 'error' ? 'bg-jolly-rose/5 border-jolly-rose/20' : 'bg-jolly-lime/5 border-jolly-lime/20'">
                <div class="flex justify-between items-start mb-3">
                    <span class="px-2 py-0.5 text-[9px] font-black uppercase tracking-widest rounded-lg" 
                          :class="{ 'bg-jolly-lime text-jolly-dark': log.status === 'success', 'bg-jolly-rose text-jolly-vivid': log.status === 'error' }" x-text="log.status"></span>
                    <span class="text-[10px] font-bold text-jolly-dark/40" x-text="formatTime(log.created_at)"></span>
                </div>
                <div class="grid grid-cols-2 gap-3 text-sm">
                    <div>
                        <span class="text-[10px] font-black text-jolly-dark/40 uppercase tracking-tighter">Item:</span>
                        <a :href="'/tracked-items#' + log.tracked_item_id" class="text-jolly-dark font-black hover:text-jolly-vivid transition-colors ml-1" x-text="'#' + log.tracked_item_id"></a>
                    </div>
                    <div>
                        <span class="text-[10px] font-black text-jolly-dark/40 uppercase tracking-tighter">Price:</span>
                        <span class="font-black text-jolly-dark ml-1">
                            <span x-show="log.price" x-text="log.currency + ' ' + log.price.toFixed(2)"></span>
                            <span x-show="!log.price" class="text-jolly-dark/20">-</span>
                        </span>
                    </div>
                    <div>
                        <span class="text-[10px] font-black text-jolly-dark/40 uppercase tracking-tighter">Model:</span>
                        <span class="ml-1 font-bold text-jolly-dark/60" x-text="log.model_used || '-'"></span>
                    </div>
                    <div>
                        <span class="text-[10px] font-black text-jolly-dark/40 uppercase tracking-tighter">Duration:</span>
                        <span class="ml-1 font-bold text-jolly-dark/60" x-text="log.duration_ms ? log.duration_ms + 'ms' : '-'"></span>
                    </div>
                </div>
                <div x-show="log.error_message" class="mt-3 p-2 bg-white/50 rounded-xl text-[10px] font-bold text-jolly-vivid border border-jolly-rose/20 break-words" x-text="log.error_message"></div>
            </div>
        </template>
        </div>

        <!-- Desktop Table View -->
        <div x-show="!loading && logs.length > 0" class="hidden sm:block overflow-hidden rounded-2xl border border-jolly-dark/5 shadow-sm">
            <table class="w-full min-w-full divide-y divide-jolly-dark/5">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-4 text-left text-[10px] font-black text-jolly-dark/40 uppercase tracking-widest">Time</th>
                        <th class="px-4 py-4 text-left text-[10px] font-black text-jolly-dark/40 uppercase tracking-widest">Item</th>
                        <th class="px-4 py-4 text-left text-[10px] font-black text-jolly-dark/40 uppercase tracking-widest">Status</th>
                        <th class="px-4 py-4 text-left text-[10px] font-black text-jolly-dark/40 uppercase tracking-widest">Price</th>
                        <th class="px-4 py-4 text-left text-[10px] font-black text-jolly-dark/40 uppercase tracking-widest hidden lg:table-cell">Model</th>
                        <th class="px-4 py-4 text-left text-[10px] font-black text-jolly-dark/40 uppercase tracking-widest hidden md:table-cell">Duration</th>
                        <th class="px-4 py-4 text-left text-[10px] font-black text-jolly-dark/40 uppercase tracking-widest hidden lg:table-cell">Details</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-jolly-dark/5">
                    <template x-for="log in logs" :key="log.id">
                        <tr class="hover:bg-jolly-lime/5 transition-colors">
                            <td class="px-4 py-4 whitespace-nowrap text-[11px] font-bold text-jolly-dark/60" x-text="formatTime(log.created_at)"></td>
                            <td class="px-4 py-4 whitespace-nowrap text-[11px] font-black text-jolly-dark">
                                <a :href="'/tracked-items#' + log.tracked_item_id" class="px-2 py-1 bg-gray-100 rounded-lg hover:bg-jolly hover:text-jolly-dark transition-all" x-text="'#' + log.tracked_item_id"></a>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-[9px] font-black uppercase tracking-widest rounded-lg" 
                                      :class="{ 'bg-jolly-lime text-jolly-dark': log.status === 'success', 'bg-jolly-rose text-jolly-vivid': log.status === 'error' }" x-text="log.status"></span>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-[12px] font-black text-jolly-dark">
                                <span x-show="log.price" x-text="log.currency + ' ' + log.price.toFixed(2)"></span>
                                <span x-show="!log.price" class="text-jolly-dark/20">-</span>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-[11px] font-bold text-jolly-dark/40 hidden lg:table-cell" x-text="log.model_used || '-'"></td>
                            <td class="px-4 py-4 whitespace-nowrap text-[11px] font-bold text-jolly-dark/40 hidden md:table-cell">
                                <span x-show="log.duration_ms" x-text="log.duration_ms + ' ms'"></span>
                                <span x-show="!log.duration_ms" class="text-jolly-dark/20">-</span>
                            </td>
                            <td class="px-4 py-4 text-[11px] font-bold text-jolly-dark/60 hidden lg:table-cell">
                                <div class="max-w-xs truncate" :title="log.error_message" x-text="log.error_message || 'OK'"></div>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Extraction Pagination -->
        <div x-show="!loading && logs.length > 0" class="py-6 flex items-center justify-between border-t border-jolly-dark/5 mt-6 bg-gray-50/30 -mx-4 -mb-4 px-6 rounded-b-3xl">
            <button @click="prevPage()" :disabled="page <= 1" 
                    class="px-6 py-2 text-[10px] font-black uppercase tracking-widest text-jolly-dark bg-white border border-jolly-dark/10 rounded-xl hover:bg-gray-50 disabled:opacity-30 transition-all shadow-sm">
                ‚Üê Prev
            </button>
            <span class="text-[10px] font-black text-jolly-dark/30 uppercase tracking-widest">Page <span class="text-jolly-dark" x-text="page"></span></span>
            <button @click="nextPage()" :disabled="!hasMore" 
                    class="px-6 py-2 text-[10px] font-black uppercase tracking-widest text-jolly-dark bg-white border border-jolly-dark/10 rounded-xl hover:bg-gray-50 disabled:opacity-30 transition-all shadow-sm">
                Next ‚Üí
            </button>
        </div>
    </div>

    <!-- Error Logs Panel -->
    <div x-show="tab === 'error'" class="p-3 sm:p-4" x-data="errorLogs()">
        {% include 'partials/error-log-filters.html' %}
        <div x-show="loading" class="text-center p-8 text-gray-500">Loading error logs...</div>
        <div x-show="!loading && logs.length === 0" class="text-center p-8 text-gray-500">No error logs found.</div>

        <!-- Mobile Card View -->
        <div x-show="!loading && logs.length > 0" class="sm:hidden space-y-3">
            <template x-for="log in logs" :key="log.id">
                <div class="border border-jolly-rose/20 bg-jolly-rose/5 rounded-2xl p-4 shadow-sm">
                    <div class="flex justify-between items-start mb-3">
                        <span class="px-2 py-0.5 text-[9px] font-black uppercase tracking-widest rounded-lg bg-jolly-rose text-jolly-vivid" x-text="log.error_type"></span>
                        <span class="text-[10px] font-bold text-jolly-dark/40" x-text="formatTime(log.created_at)"></span>
                    </div>
                    <p class="text-[11px] font-bold text-jolly-dark/80 break-words mb-3" x-text="log.message"></p>
                    <div class="flex gap-4 text-[10px] font-black uppercase tracking-widest">
                        <a x-show="log.url" :href="log.url" target="_blank" class="text-jolly-dark/40 hover:text-jolly-vivid transition-colors">üîó View URL</a>
                        <a x-show="log.screenshot_path" :href="log.screenshot_path" target="_blank" class="text-jolly-dark/40 hover:text-jolly-vivid transition-colors">üñºÔ∏è Screenshot</a>
                    </div>
                </div>
            </template>
        </div>

        <!-- Desktop Table View -->
        <div x-show="!loading && logs.length > 0" class="hidden sm:block overflow-hidden rounded-2xl border border-jolly-dark/5 shadow-sm">
            <table class="w-full min-w-full divide-y divide-jolly-dark/5">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-4 text-left text-[10px] font-black text-jolly-dark/40 uppercase tracking-widest">Time</th>
                        <th class="px-4 py-4 text-left text-[10px] font-black text-jolly-dark/40 uppercase tracking-widest">Error Type</th>
                        <th class="px-4 py-4 text-left text-[10px] font-black text-jolly-dark/40 uppercase tracking-widest">Message</th>
                        <th class="px-4 py-4 text-left text-[10px] font-black text-jolly-dark/40 uppercase tracking-widest hidden md:table-cell">URL</th>
                        <th class="px-4 py-4 text-left text-[10px] font-black text-jolly-dark/40 uppercase tracking-widest hidden md:table-cell">Screenshot</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-jolly-dark/5">
                    <template x-for="log in logs" :key="log.id">
                        <tr class="hover:bg-jolly-rose/5 transition-colors">
                            <td class="px-4 py-4 whitespace-nowrap text-[11px] font-bold text-jolly-dark/60" x-text="formatTime(log.created_at)"></td>
                            <td class="px-4 py-4 whitespace-nowrap">
                                <span class="px-2 py-1 text-[9px] font-black uppercase tracking-widest rounded-lg bg-jolly-rose text-jolly-vivid" x-text="log.error_type"></span>
                            </td>
                            <td class="px-4 py-4 text-[11px] font-bold text-jolly-dark/60 max-w-xs truncate" x-text="log.message" :title="log.message"></td>
                            <td class="px-4 py-4 whitespace-nowrap text-[10px] font-black uppercase tracking-widest hidden md:table-cell">
                                <a :href="log.url" target="_blank" class="px-2 py-1 bg-gray-100 rounded-lg text-jolly-dark/40 hover:bg-jolly hover:text-jolly-dark transition-all" x-text="log.url ? 'üîó Link' : '-'"></a>
                            </td>
                            <td class="px-4 py-4 whitespace-nowrap text-[10px] font-black uppercase tracking-widest hidden md:table-cell">
                                <a :href="log.screenshot_path" target="_blank" class="px-2 py-1 bg-gray-100 rounded-lg text-jolly-dark/40 hover:bg-jolly hover:text-jolly-dark transition-all" x-text="log.screenshot_path ? 'üñºÔ∏è View' : '-'"></a>
                            </td>
                        </tr>
                    </template>
                </tbody>
            </table>
        </div>

        <!-- Error Pagination -->
        <div x-show="!loading && logs.length > 0" class="py-6 flex items-center justify-between border-t border-jolly-dark/5 mt-6 bg-gray-50/30 -mx-4 -mb-4 px-6 rounded-b-3xl">
            <button @click="prevPage()" :disabled="page <= 1" 
                    class="px-6 py-2 text-[10px] font-black uppercase tracking-widest text-jolly-dark bg-white border border-jolly-dark/10 rounded-xl hover:bg-gray-50 disabled:opacity-30 transition-all shadow-sm">
                ‚Üê Prev
            </button>
            <span class="text-[10px] font-black text-jolly-dark/30 uppercase tracking-widest">Page <span class="text-jolly-dark" x-text="page"></span></span>
            <button @click="nextPage()" :disabled="!hasMore" 
                    class="px-6 py-2 text-[10px] font-black uppercase tracking-widest text-jolly-dark bg-white border border-jolly-dark/10 rounded-xl hover:bg-gray-50 disabled:opacity-30 transition-all shadow-sm">
                Next ‚Üí
            </button>
        </div>
    </div>
</div>

<script>
function fullLogs() {
    return {
        logs: [], loading: true, page: 1, limit: 100, hasMore: false,
        filters: { status: '', itemId: '', startDate: '', endDate: '' },
        init() { this.loadLogs(); window.addEventListener('log-filter-changed', e => { this.filters = e.detail; this.loadLogs(); }); },
        buildQuery() {
            let q = `?limit=${this.limit}&offset=${(this.page - 1) * this.limit}`;
            if (this.filters.status) q += `&status=${this.filters.status}`;
            if (this.filters.itemId) q += `&item_id=${this.filters.itemId}`;
            if (this.filters.startDate) q += `&start_date=${this.filters.startDate}`;
            if (this.filters.endDate) q += `&end_date=${this.filters.endDate}`;
            return q;
        },
        async loadLogs() {
            this.loading = true;
            try {
                const res = await fetch(`/api/logs${this.buildQuery()}`);
                const data = await res.json();
                this.logs = data;
                this.hasMore = data.length === this.limit;
            } catch (e) { console.error('Failed to load logs:', e); this.logs = []; this.hasMore = false; }
            finally { this.loading = false; }
        },
        nextPage() { if (this.hasMore) { this.page++; this.loadLogs(); } },
        prevPage() { if (this.page > 1) { this.page--; this.loadLogs(); } },
        formatTime(iso) { return iso ? new Date(iso).toLocaleString('en-US', { dateStyle: 'short', timeStyle: 'medium' }) : '-'; }
    }
}

function errorLogs() {
    return {
        logs: [], loading: true, page: 1, limit: 100, hasMore: false,
        filters: { errorType: '', startDate: '', endDate: '' },
        init() { this.loadLogs(); window.addEventListener('error-log-filter-changed', e => { this.filters = e.detail; this.loadLogs(); }); },
        buildQuery() {
            let q = `?limit=${this.limit}&offset=${(this.page - 1) * this.limit}`;
            if (this.filters.errorType) q += `&error_type=${this.filters.errorType}`;
            if (this.filters.startDate) q += `&start_date=${this.filters.startDate}`;
            if (this.filters.endDate) q += `&end_date=${this.filters.endDate}`;
            return q;
        },
        async loadLogs() {
            this.loading = true;
            try {
                const res = await fetch(`/api/errors${this.buildQuery()}`);
                const data = await res.json();
                this.logs = data;
                this.hasMore = data.length === this.limit;
            } catch (e) { console.error('Failed to load error logs:', e); this.logs = []; this.hasMore = false; }
            finally { this.loading = false; }
        },
        nextPage() { if (this.hasMore) { this.page++; this.loadLogs(); } },
        prevPage() { if (this.page > 1) { this.page--; this.loadLogs(); } },
        formatTime(iso) { return iso ? new Date(iso).toLocaleString('en-US', { dateStyle: 'short', timeStyle: 'medium' }) : '-'; }
    }
}
</script>

{% endblock %}
